#!/bin/bash

# what executables will we use?
declare -r CUT="/usr/bin/cut"
declare -r DATE="/bin/date"
declare -r SLEEP="/bin/sleep"
declare -r SED="/bin/sed"
declare -r VCGENCMD="/usr/bin/vcgencmd"

# what is our run interval (in seconds)
declare -r INTERVAL=5

function GetSystemTemperature() {
    $VCGENCMD measure_temp | $SED -E 's/^.*=([0-9.]+).*$/\1/'
}

function GetCoreFrequency() {
    $VCGENCMD measure_clock arm | $CUT -d= -f2
}

function GetVoltage() {
    $VCGENCMD measure_volts | $SED -E 's/^.*=([0-9.]+).*$/\1/'
}

function GetFrequencyCapped() {
    local bits
    local capped

    bits=$($VCGENCMD get_throttled | cut -d= -f2)
    capped=$(( bits & 0x00002 ))
    echo "$capped"
}

function GetThrottled() {
    local bits
    local throttled

    bits=$($VCGENCMD get_throttled | cut -d= -f2)
    throttled=$(( bits & 0x00004 ))
    echo "$throttled"
}

function DoPerformanceLoop() {
    local start_seconds
    start_seconds=$($DATE +%s)

    while : ; do
        local current_seconds
        local elapsed
        local temperature
        local frequency
        local voltage
        local capped
        local throttled

        current_seconds=$($DATE +%s)
        elapsed=$(( current_seconds - start_seconds ))
        temperature=$(GetSystemTemperature)
        frequency=$(GetCoreFrequency)
        voltage=$(GetVoltage)
        capped=$(GetFrequencyCapped)
        throttled=$(GetThrottled)

        echo -n "$elapsed"
        echo -en "\\t$temperature"
        echo -en "\\t$frequency"
        echo -en "\\t$voltage"
        echo -en "\\t$capped"
        echo -en "\\t$throttled"
        echo

        $SLEEP $INTERVAL
    done
}


DoPerformanceLoop

